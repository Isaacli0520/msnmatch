<!-- templates/skill_search.html -->
{% extends 'base.html' %}
{% load bootstrap4 %}
{% bootstrap_css %}
{% load static %}

{% block title %}Skill Search{% endblock %}

{% block css %}
<link href="{% static 'css/autocomplete_skill.css' %}" rel="stylesheet">
<link href="{% static 'css/tags_color.css' %}" rel="stylesheet">
{% endblock %}


{% block content %}
<link rel="stylesheet"  href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.8.1/css/all.css"></script>
<script src="{% static 'js/autocomplete.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.js"></script>


  <div class="container">
    <!-- <div class = "justify-content-center"> -->
    <br />
    <div class="col-12 mb-5" style = "width:100%; margin: 0 auto;">
        <div class="container mt-5 mb-4 text-center">
            <h1 class="display-4" style="font-family: Palatino, URW Palladio L, serif;">Add Your Interests</h1>
            <h6 class="text-muted">Search for existing tags or Add your own tags</h6>
        </div>
    </div>
    <div class="col-xs-12 col-sm-12 col-md-10 col-lg-8 col-xs-offset-0 col-sm-offset-0" id = "skill-list-app" style="width:100%; margin: 0 auto;">
        <div class="autocomplete mb-4" style="width:100%;">
            <autocomplete-comp></autocomplete-comp>
        </div>
    </div>
    </div>

    <br />

  </div>

<script>
    Vue.component('autocomplete-comp', {
        template: `
        <div>
            <div class="mt-2 mb-2">
                <div class="skill-user-tags mb-3">
                    <template class="skill-user-span" v-for="(skills_of_type, skills_type_name) in skills">
                        <span v-for="skill in skills_of_type"
                            class="skill-user-tag"
                            v-bind:class="skill.skill_type">
                            <span>\{\{skill.skill_name\}\}</span>
                            <span class="skill-tag-remove"><i v-on:click="del_skill(skill, skills_type_name)" class="fas fa-times"></i></span>
                        </span>
                    </template>
                </div>
                <div class=" mt-4">
                    <div class="search-form">
                        <div class="search-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <input v-on:keyup="autocomplete_func" autocomplete="off" v-model="searchquery" id="myInput" type="text" name="class" placeholder="Search for a skill" class="search-input" aria-label="Search">
                    </div>
                    <div class="autocomplete-items">
                        <div class="autocomplete-item" v-for="skill in skill_results" v-on:click="add_skill(skill)" :value="skill.skill_pk">
                            <span>\{\{ skill.skill_name \}\}</span>
                            <span style="float:right; font-family: Gill Sans, sans-serif;" v-if="skill.skill_cus">Enter a customized tag</span>
                            <span style="float:right; font-family: Gill Sans, sans-serif;" v-if="!skill.skill_cus">Enter an existing tag</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 mb-3">
                <tags-comp :all_skills="all_skills" @update_skills_add="child_add_skill"></tags-comp>
            </div>
        </div>
        `,
        data: function () {
            return {
                searchquery: '',
                skill_results: [],
                skills:[],
                all_skills:[],
            }
        },
        methods:{
            get_all_skills(){
                axios.get('/skills/ajax/get_all_skills/',{params: {}}).then(response => {
                    this.all_skills = response.data.all_skills;
                });
            },
            get_all_user_skills(){
                axios.get('/skills/ajax/get_all_user_skills/',{params: {}}).then(response => {
                    this.skills = response.data.all_skills;
                });
            },
            autocomplete_func(){
                if (this.searchquery.length == 0){
                    this.skill_results = [];
                }
                axios.get('/skills/ajax/result/',{params: {searchquery: this.searchquery}}).then(response => {
                    this.skill_results = [];
                    this.skill_results = response.data.skill_list;
                    if (this.searchquery.length > 0){
                        var user_enter_skill = {
                            "skill_pk": 0,
                            "skill_name": this.searchquery,
                            "skill_intro": "",
                            "skill_type": "Custom",
                            "skill_exist": false,
                            "skill_cus":true,
                        };
                        this.skill_results.push(user_enter_skill);
                    }
                    });
            },
            add_skill(skill){
                axios.get('/skills/ajax/add_del_skill/',{params: {skill_pk: skill.skill_pk, add_del:"add", skill_cus:skill.skill_cus, skill_name:skill.skill_name}}).then(response => {
                    if (skill.skill_exist == false){
                        skill.skill_exist = true;
                        // this.skills.push(skill);
                        if (!response.data.origin_exist){
                            this.skills[skill.skill_type].splice(this.skills[skill.skill_type].indexOf(skill), 0, skill);
                        }
                    }
                    });
            },
            del_skill(skill, skills_type_name){
                axios.get('/skills/ajax/add_del_skill/',{params: {skill_pk: skill.skill_pk, add_del:"del", skill_name:skill.skill_name}}).then(response => {
                    // console.log("delete a skill");  
                    if (skill.skill_exist == true){
                        // console.log("I'm in");
                        skill.skill_exist = false;
                        // this.skills.splice(this.skills.indexOf(skill), 1);
                        this.skills[skills_type_name].splice(this.skills[skills_type_name].indexOf(skill), 1);
                        if (skill.skill_type != "Custom"){
                            this.all_skills[skills_type_name].push(skill);
                        }
                    }
                    });
            },
            child_add_skill(skill){
                this.add_skill(skill);
            },
            go_to_skill(skill){
                window.location.href = "/skills/"+ skill.skill_pk;
            },
        },
        mounted(){
            this.get_all_user_skills();
            this.get_all_skills();
        },
        })
        
    Vue.component('tags-comp', {
        props:['all_skills'],
        template: `
        <div>
            <div v-for="(skills_of_type, skills_type_name) in all_skills">
                <h4>\{\{skill_type_names[skills_type_name]\}\}</h4>
                <div class="skill-tags">
                    <span v-for="skill in skills_of_type"
                        class="skill-tag"
                        v-bind:class="skill.skill_type"
                        @click="add_skill(skill,skills_type_name)">
                        <span>\{\{skill.skill_name\}\}</span>
                    </span>
                </div>
            </div>
        </div>
        `,
        data: function () {
            return {
                skill_type_names: {
                    "Game":"Game",
                    "Academic":"Academic Interests",
                    "Film and TV":"Film and TV",
                    "Sport":"Sport",
                    "Music":"Music",
                    "Language":"Language",
                    "General":"General",
                    "Books":"Books",
                },
            }
        },
        methods:{
            add_skill(skill, skills_type_name){
                this.$emit('update_skills_add', skill);
                this.all_skills[skills_type_name].splice(this.all_skills[skills_type_name].indexOf(skill), 1);
            },
        },
        mounted(){
        },
        })

    var skill_list_app = new Vue({
        el: "#skill-list-app",
    })
</script>
{% endblock %}
