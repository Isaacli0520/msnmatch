<!-- templates/super_admin.html -->
{% extends 'base.html' %}
{% load bootstrap4 %}
{% bootstrap_css %}
{% load static %}

{% block title %}Super Admin{% endblock %}

{% block css %}
    <link href="{% static 'css/super_admin.css' %}" rel="stylesheet">
{% endblock %}


{% block content %}
{% if request.user.is_superuser %}
    <div class="mt-3 mb-3 col-xs-12 col-sm-12 col-md-10 col-lg-8 col-xs-offset-0 col-sm-offset-0 container" id="admin-app" style="width:100%; margin: 0 auto;">
        <div class="big-title text-center mt-3 mb-3">
            <span>Super Cool Admin Page</span>
        </div>
        <user-list-rank-comp
        v-bind:all_users="all_users"
        v-bind:all_users_list="all_users_list"
        ></user-list-rank-comp>
    </div>
{% else %}
    <div>
        <h1>Error</h1>
    </div>
{% endif %}

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.js"></script>

<script>
    Vue.filter('plr', function (value) {
        if (value > 1){
            return value.toString(10) + " Followers";
        }else{
            return value.toString(10) + " Follower";
        }
    });

    Vue.component('user-list-rank-comp', {
            props:["all_users","all_users_list"],
            template: `
            <div class="all-users">
                <div v-for="user in all_users_list">
                    <div class="user-big-div">
                        <div class="user-div" @click=collapseDiv(user.pk)>
                            <span class="user-main font-weight-bold">\{\{ user.first_name }} \{\{ user.last_name \}\}</span>
                            <span v-if="user.role" class="user-role" :class="user.role">\{\{ user.role \}\}</span> 
                            <span v-if="user.year" class="user-year">\{\{ user.year \}\}</span>
                            <span v-if="user.follow.length > 0" class="user-follow">\{\{ user.follow.length | plr \}\}</span>
                        </div>
                        <div class="collapse multi-collapse" :id="user.pk">
                            <div class="card card-body w-100">
                                <span class="text-center">Followed by</span>
                                <div class=" card-columns">
                                    <user-rank-comp
                                    v-for="user_flw_pk in user.follow"
                                    v-bind:key="user_flw_pk"
                                    v-bind:tmp_user="all_users[user_flw_pk]"
                                    ></user-rank-comp>
                                </div>
                                <hr>
                                <span class="text-center">Followed</span>
                                <div class=" card-columns">
                                    <user-rank-comp
                                    v-for="user_flwee_pk in user.followee"
                                    v-bind:key="user_flwee_pk"
                                    v-bind:tmp_user="all_users[user_flwee_pk]"
                                    ></user-rank-comp>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `,
            data: function () {
                return {
                    
                }
            },
            methods:{
                collapseDiv(user_pk){
                    let tmp_string = "#" + user_pk;
                    $(tmp_string).collapse('toggle');
                },
            },
            mounted(){
                
            },
        })

        Vue.component('user-rank-comp', {
            props:["tmp_user",],
            template: `
            <div class="card user-card">
                <div class="user-card-inner">
                    <img v-if="tmp_user.picture" class="card-img-top" :src="tmp_user.picture" alt="none">
                    <div class="card-body">
                        <div class="title d-flex w-100 justify-content-between">
                            <h5 class="mb-1 font-weight-bold">
                                \{\{tmp_user.first_name\}\} \{\{tmp_user.last_name\}\}
                            </h5>
                            <small style="float:right;">\{\{ tmp_user.year \}\}</small>
                        </div>
                        <div class="title d-flex w-100 justify-content-between">
                            <small v-if="tmp_user.major" class="text-muted">Major: \{\{ tmp_user.major \}\}</small>
                        </div>
                    </div>
                </div>
            </div>
            `,
            data: function () {
                return {
                    
                }
            },
            methods:{
            },
            mounted(){
                
            },
        })

    var admin_app = new Vue({
            el: "#admin-app",
            data: {
                all_users: {},
                all_users_list:[],
            },
            methods:{},
            mounted(){
                axios.get('/ajax/get_all_ranked_users/',{params: {}}).then(response => {
                    // console.log(response.data.all_users);
                    this.all_users = response.data.all_users;
                    let tmp_arr = [];
                    for (const [ key, value ] of Object.entries(this.all_users)) {
                        tmp_arr = tmp_arr.concat(value);
                    }
                    tmp_arr = tmp_arr.sort(function(a,b){
                        return b.follow.length - a.follow.length;
                    });
                    this.all_users_list = tmp_arr;
                });
            },
    })
</script>
{% endblock %}
